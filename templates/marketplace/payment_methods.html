{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Payment Methods</h4>
                    <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                        <i class="fas fa-plus"></i> Add New Card
                    </button>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}" role="alert">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    {% if payment_methods %}
                        <div class="list-group">
                            {% for method in payment_methods %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-credit-card me-2"></i>
                                        {{ method.card.brand|title }} ending in {{ method.card.last4 }}
                                        <small class="text-muted">
                                            Expires {{ method.card.exp_month }}/{{ method.card.exp_year }}
                                        </small>
                                    </div>
                                    <form action="{{ url_for('marketplace.delete_payment_method') }}" method="POST" class="d-inline">
                                        <input type="hidden" name="payment_method_id" value="{{ method.id }}">
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                            <p class="lead">No payment methods added yet</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                                Add Your First Card
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Payment Method Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Payment Method</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="payment-form" action="{{ url_for('marketplace.add_payment_method') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div id="payment-element">
                        <!-- Stripe Elements will be inserted here -->
                    </div>
                    <div id="payment-message" class="hidden"></div>
                    <button id="submit" class="btn btn-primary w-100 mt-3">
                        <div class="spinner hidden" id="spinner"></div>
                        <span id="button-text">Add Payment Method</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    const paymentElement = elements.create('payment');
    paymentElement.mount('#payment-element');

    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const {error} = await stripe.confirmSetup({
            elements,
            confirmParams: {
                return_url: '{{ url_for("marketplace.payment_methods", _external=True) }}',
            }
        });
        
        if (error) {
            const messageDiv = document.getElementById('payment-message');
            messageDiv.textContent = error.message;
        }
    });
</script>
{% endblock %}
